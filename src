local tween_service = game:GetService("TweenService")
local uis = game:GetService("UserInputService")
local run = game:GetService("RunService")
local text_service = game:GetService("TextService")
local players = game:GetService("Players")
local lp = players.LocalPlayer

local vec2 = Vector2.new
local dim2 = UDim2.new
local dim = UDim.new
local rgb = Color3.fromRGB
local color = Color3.new
local rect = Rect.new

local library = {}
library.__index = library
library.commands = {}

function library.new(name, auto_config)
	local self = setmetatable({}, library)
	self.name = name or "UI Lib"
	self.auto_config = auto_config
	self.start_time = tick()
	self.screen_gui = nil
	self.notification_container = nil
	self.cmd_bar_frame = nil
	self.command_list_holder = nil
	self.command_list_frame = nil
	self.cl_shadow = nil
	self.cl_scale = nil
	self.scrolling_frame = nil
	self.prefix = ">"
	self.toggle_key = Enum.KeyCode.Semicolon
	return self
end

function library:init()
	local screen_gui = Instance.new("ScreenGui")
	screen_gui.Name = "ZeeAdminUI"
	screen_gui.ResetOnSpawn = false
	screen_gui.DisplayOrder = 10000
	
	pcall(function()
		if gethui then
			screen_gui.Parent = gethui()
		elseif syn and syn.protect_gui then
			syn.protect_gui(screen_gui)
			screen_gui.Parent = game:GetService("CoreGui")
		elseif game:GetService("CoreGui") then
			screen_gui.Parent = game:GetService("CoreGui")
		else
			screen_gui.Parent = lp:WaitForChild("PlayerGui")
		end
	end)
	
	if not screen_gui.Parent then
		screen_gui.Parent = lp:WaitForChild("PlayerGui")
	end
	
	self.screen_gui = screen_gui
	
	local notification_container = Instance.new("Frame")
	notification_container.Name = "NotificationContainer"
	notification_container.Size = dim2(0, 250, 1, 0)
	notification_container.Position = dim2(0, 20, 0, 80)
	notification_container.BackgroundTransparency = 1
	notification_container.Parent = screen_gui
	
	local notification_layout = Instance.new("UIListLayout")
	notification_layout.Parent = notification_container
	notification_layout.SortOrder = Enum.SortOrder.LayoutOrder
	notification_layout.VerticalAlignment = Enum.VerticalAlignment.Top
	notification_layout.Padding = dim(0, 10)
	
	self.notification_container = notification_container

	if self.auto_config then
		self:load_config()
	end
	
	self:register_default_commands()
	
	local load_time = tick() - self.start_time
	self:notify(string.format("%s Loaded (%.2fs)", self.name, load_time), 5)
end

function library:get_config_path()
	return self.name .. "_config.json"
end

function library:load_config()
	if not isfile or not readfile or not isfile(self:get_config_path()) then return end
	
	local success, result = pcall(function()
		return game:GetService("HttpService"):JSONDecode(readfile(self:get_config_path()))
	end)
	
	if success and result then
		if result.Prefix then self.prefix = result.Prefix end
		if result.ToggleKey then 
			local key = Enum.KeyCode[result.ToggleKey]
			if key then self.toggle_key = key end
		end
	end
end

function library:save_config()
	if not writefile then return end
	
	local data = {
		Prefix = self.prefix,
		ToggleKey = self.toggle_key.Name
	}
	
	pcall(function()
		writefile(self:get_config_path(), game:GetService("HttpService"):JSONEncode(data))
	end)
end

function library:register_default_commands()
	self:add_command("cmds", "", "Show command list", function()
		self:toggle_command_list(true)
	end)
	self:add_command("commands", "", "Show command list", function()
		self:toggle_command_list(true)
	end)
	
	self:add_command("prefix", "[new_prefix]", "Change command prefix", function(new_prefix)
		if new_prefix and new_prefix ~= "" then
			self.prefix = new_prefix
			if self.cmd_bar_frame and self.cmd_bar_frame:FindFirstChild("PromptLabel") then
				self.cmd_bar_frame.PromptLabel.Text = new_prefix
			end
			
			self:notify("Prefix set to " .. new_prefix)
			if self.auto_config then self:save_config() end
		end
	end)
	
	self:add_command("rejoin", "", "Rejoin the server", function()
		if #players:GetPlayers() <= 1 then
			lp:Kick("\nRejoining...")
			task.wait()
			game:GetService("TeleportService"):Teleport(game.PlaceId, lp)
		else
			game:GetService("TeleportService"):TeleportToPlaceInstance(game.PlaceId, game.JobId, lp)
		end
	end)
	
	self:add_command("serverhop", "", "Hop to a different server", function()
		local http = game:GetService("HttpService")
		local tps = game:GetService("TeleportService")
		local api = "https://games.roblox.com/v1/games/"
		
		local _place = game.PlaceId
		local _servers = api.._place.."/servers/Public?sortOrder=Asc&limit=100"
		
		local function list_servers(cursor)
			local raw = game:HttpGet(_servers .. ((cursor and "&cursor="..cursor) or ""))
			return http:JSONDecode(raw)
		end
		
		local server, next_cursor; repeat
			local servers = list_servers(next_cursor)
			server = servers.data[1]
			next_cursor = servers.nextPageCursor
		until server
		
		tps:TeleportToPlaceInstance(_place, server.id, lp)
	end)
	
	self:add_command("cls", "", "Clear client chat/console logs", function()
		if game:GetService("TextChatService").ChatVersion == Enum.ChatVersion.TextChatService then
		elseif game:GetService("ReplicatedStorage"):FindFirstChild("DefaultChatSystemChatEvents") then
		end
		print(string.rep("\n", 50))
		self:notify("Console/Output cleared (locally)")
	end)
end

function library:add_command(name, args, desc, callback, aliases)
	local arg_display = args or ""
	
	local cmd_data = {
		name = name,
		aliases = aliases or {},
		args_display = arg_display,
		desc = desc or "No description provided.",
		callback = callback
	}
	
	table.insert(self.commands, cmd_data)
	
	if self.scrolling_frame then
		self:populate_command_list()
	end
end

function library:run_command(input)
	if input:sub(1, #self.prefix) ~= self.prefix then return end
	
	local clean_input = input:sub(#self.prefix + 1)
	local split = clean_input:split(" ")
	local cmd_name = split[1]:lower()
	table.remove(split, 1)
	
	local found_cmd
	for _, cmd in ipairs(self.commands) do
		if cmd.name:lower() == cmd_name then
			found_cmd = cmd
			break
		end
		if cmd.aliases then
			for _, alias in ipairs(cmd.aliases) do
				if alias:lower() == cmd_name then
					found_cmd = cmd
					break
				end
			end
		end
		if found_cmd then break end
	end
	
	if found_cmd then
		task.spawn(function()
			local success, err = pcall(function()
				found_cmd.callback(unpack(split))
			end)
			if not success then
				warn("Command Error:", err)
				self:notify("Error: " .. tostring(err), 5)
			end
		end)
	else
		self:notify("Command not found: " .. cmd_name, 2)
	end
end

function library:notify(text, duration)
	if not self.notification_container then return end
	duration = duration or 3
	
	local holder = Instance.new("Frame")
	holder.BackgroundTransparency = 1
	holder.Size = dim2(1, 0, 0, 40)
	holder.Parent = self.notification_container
	
	local inner = Instance.new("Frame")
	inner.Size = dim2(1, 0, 1, 0)
	inner.Position = dim2(-1.2, 0, 0, 0)
	inner.BackgroundColor3 = rgb(45, 45, 45)
	inner.BackgroundTransparency = 0.15
	inner.BorderSizePixel = 0
	inner.Parent = holder
	
	local ui_corner = Instance.new("UICorner")
	ui_corner.CornerRadius = dim(0, 6)
	ui_corner.Parent = inner
	
	local ui_stroke = Instance.new("UIStroke")
	ui_stroke.Color = rgb(255, 255, 255)
	ui_stroke.Transparency = 0.85
	ui_stroke.Thickness = 1
	ui_stroke.Parent = inner
	
	local shadow = Instance.new("ImageLabel")
	shadow.Name = "Shadow"
	shadow.AnchorPoint = vec2(0.5, 0.5)
	shadow.Position = UDim2.fromScale(0.5, 0.5)
	shadow.Size = dim2(1, 10, 1, 10)
	shadow.BackgroundTransparency = 1
	shadow.Image = "rbxassetid://1316045217"
	shadow.ImageColor3 = rgb(0, 0, 0)
	shadow.ImageTransparency = 0.6
	shadow.SliceCenter = rect(10, 10, 118, 118)
	shadow.ScaleType = Enum.ScaleType.Slice
	shadow.ZIndex = 0
	shadow.Parent = inner
	
	local bar = Instance.new("Frame")
	bar.Name = "AccentBar"
	bar.Size = dim2(0, 3, 0.6, 0)
	bar.Position = dim2(0, 6, 0.2, 0)
	bar.BackgroundColor3 = rgb(255, 255, 255)
	bar.BorderSizePixel = 0
	bar.Parent = inner
	
	local bar_corner = Instance.new("UICorner")
	bar_corner.CornerRadius = dim(1, 0)
	bar_corner.Parent = bar
	
	local label = Instance.new("TextLabel")
	label.Size = dim2(1, -25, 1, 0)
	label.Position = dim2(0, 16, 0, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = rgb(240, 240, 240)
	label.TextSize = 14
	label.Font = Enum.Font.GothamMedium
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.RichText = true
	label.Parent = inner
	
	local subject, status = text:match("^(.*)%s+(Enabled)$")
	if not subject then subject, status = text:match("^(.*)%s+(Disabled)$") end
	if not subject then subject, status = text:match("^(.*)%s+(Allowed)$") end
	if not subject then subject, status = text:match("^(.*)%s+(Disallowed)$") end
	
	if subject and status then
		local is_green = (status == "Enabled" or status == "Allowed")
		local color_hex = is_green and "#64ff64" or "#ff6464"
		label.Text = string.format("<b>%s</b> <font color='%s'>%s</font>", subject, color_hex, status)
		bar.BackgroundColor3 = is_green and rgb(100, 255, 100) or rgb(255, 100, 100)
	else
		if text:lower():find("target") or text:lower():find("kill") or text:lower():find("stomp") then
			bar.BackgroundColor3 = rgb(255, 150, 50)
		elseif text:lower():find("set to") then
			bar.BackgroundColor3 = rgb(100, 200, 255)
		end
	end
	
	tween_service:Create(inner, TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
		Position = dim2(0, 0, 0, 0)
	}):Play()
	
	task.delay(duration, function()
		if not inner.Parent then return end
		local tween = tween_service:Create(inner, TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {
			Position = dim2(-1.2, 0, 0, 0)
		})
		tween:Play()
		tween.Completed:Wait()
		holder:Destroy()
	end)
end

function library:create_command_bar(prefix)
	if self.prefix == ">" and prefix then
		self.prefix = prefix
	end
	
	local backdrop = Instance.new("Frame")
	backdrop.Name = "Backdrop"
	backdrop.Size = dim2(1, 0, 1, 0)
	backdrop.BackgroundColor3 = color(0, 0, 0)
	backdrop.BackgroundTransparency = 1
	backdrop.Visible = false
	backdrop.Parent = self.screen_gui
	
	local cmd_bar_frame = Instance.new("Frame")
	cmd_bar_frame.Name = "CmdBarFrame"
	cmd_bar_frame.Size = dim2(0, 250, 0, 35)
	cmd_bar_frame.AnchorPoint = vec2(0.5, 0)
	cmd_bar_frame.Position = dim2(0.5, 0, 0.95, -46) 
	cmd_bar_frame.BackgroundColor3 = rgb(45, 45, 45)
	cmd_bar_frame.BorderSizePixel = 0
	cmd_bar_frame.BackgroundTransparency = 1
	cmd_bar_frame.Parent = backdrop
	
	local shadow = Instance.new("ImageLabel")
	shadow.Name = "Shadow"
	shadow.AnchorPoint = vec2(0.5, 0.5)
	shadow.Position = UDim2.fromScale(0.5, 0.5)
	shadow.Size = dim2(1, 10, 1, 10)
	shadow.BackgroundTransparency = 1
	shadow.Image = "rbxassetid://1316045217"
	shadow.ImageColor3 = rgb(0, 0, 0)
	shadow.ImageTransparency = 1
	shadow.ScaleType = Enum.ScaleType.Slice
	shadow.SliceCenter = rect(10, 10, 118, 118)
	shadow.ZIndex = cmd_bar_frame.ZIndex - 1
	shadow.Parent = cmd_bar_frame
	
	local ui_corner = Instance.new("UICorner")
	ui_corner.CornerRadius = dim(0, 6)
	ui_corner.Parent = cmd_bar_frame
	
	local ui_stroke = Instance.new("UIStroke")
	ui_stroke.Color = rgb(80, 80, 80)
	ui_stroke.Thickness = 1
	ui_stroke.Transparency = 1
	ui_stroke.Parent = cmd_bar_frame
	
	local prompt_label = Instance.new("TextLabel")
	prompt_label.Name = "PromptLabel"
	prompt_label.Size = dim2(0, 20, 1, 0)
	prompt_label.Position = dim2(0, 10, 0, 0)
	prompt_label.BackgroundTransparency = 1
	prompt_label.Text = self.prefix
	prompt_label.TextColor3 = rgb(150, 150, 150)
	prompt_label.TextSize = 18
	prompt_label.Font = Enum.Font.SourceSans
	prompt_label.TextXAlignment = Enum.TextXAlignment.Center
	prompt_label.Parent = cmd_bar_frame
	
	local suggestion_label = Instance.new("TextLabel")
	suggestion_label.Name = "SuggestionLabel"
	suggestion_label.Size = dim2(1, -40, 1, 0)
	suggestion_label.Position = dim2(0, 35, 0, 0)
	suggestion_label.BackgroundTransparency = 1
	suggestion_label.Text = ""
	suggestion_label.TextColor3 = rgb(200, 200, 200)
	suggestion_label.TextTransparency = 0.5
	suggestion_label.TextSize = 18
	suggestion_label.RichText = false
	suggestion_label.Font = Enum.Font.SourceSans
	suggestion_label.TextXAlignment = Enum.TextXAlignment.Left
	suggestion_label.Parent = cmd_bar_frame
	
	local input_box = Instance.new("TextBox")
	input_box.Name = "InputBox"
	input_box.Size = dim2(1, -40, 1, 0)
	input_box.Position = dim2(0, 35, 0, 0)
	input_box.BackgroundTransparency = 1
	input_box.Text = ""
	input_box.PlaceholderText = ""
	input_box.TextColor3 = rgb(200, 200, 200)
	input_box.PlaceholderColor3 = rgb(100, 100, 100)
	input_box.TextSize = 18
	input_box.Font = Enum.Font.SourceSans
	input_box.TextXAlignment = Enum.TextXAlignment.Left
	input_box.ClearTextOnFocus = false
	input_box.Parent = cmd_bar_frame
	
	self.cmd_bar_frame = cmd_bar_frame
	self.backdrop = backdrop
	self.input_box = input_box
	self.suggestion_label = suggestion_label
	
	local current_match = nil
	local current_suggestion_full = ""
	local is_visible = false
	
	local function toggle_cmd_bar(state)
		if state ~= nil then is_visible = state else is_visible = not is_visible end
		
		if is_visible then
			backdrop.Visible = true
			cmd_bar_frame.Visible = true
			
			tween_service:Create(cmd_bar_frame, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
				BackgroundTransparency = 0.15,
				Position = dim2(0.5, 0, 0.92, -46)
			}):Play()
			tween_service:Create(shadow, TweenInfo.new(0.3), {ImageTransparency = 0.8}):Play()
			tween_service:Create(ui_stroke, TweenInfo.new(0.3), {Transparency = 0}):Play()
			
			task.delay(0.1, function()
				if is_visible then
					input_box.Text = ""
					input_box:CaptureFocus()
				end
			end)
		else
			tween_service:Create(cmd_bar_frame, TweenInfo.new(0.2, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {
				BackgroundTransparency = 1,
				Position = dim2(0.5, 0, 0.95, -46)
			}):Play()
			tween_service:Create(shadow, TweenInfo.new(0.2), {ImageTransparency = 1}):Play()
			tween_service:Create(ui_stroke, TweenInfo.new(0.2), {Transparency = 1}):Play()
			
			input_box.Text = ""
			suggestion_label.Text = ""
			input_box:ReleaseFocus()
			
			task.delay(0.2, function()
				if not is_visible then
					backdrop.Visible = false
				end
			end)
		end
	end
	
	local function update_suggestion()
		local text = input_box.Text
		
		if text:find("\t") then
			text = text:gsub("\t", "")
			input_box.Text = text
			input_box.CursorPosition = #text + 1
		end
		
		suggestion_label.Text = ""
		current_match = nil
		current_suggestion_full = ""
		
		if text == "" then return end
		
		local clean_text = text
		if clean_text:sub(1, #self.prefix) == self.prefix then
			clean_text = clean_text:sub(#self.prefix + 1)
		end
		
		if clean_text == "" then return end
		
		local args = clean_text:split(" ")
		local cmd_part = args[1]:lower()
		
		if #args == 1 then
			for _, cmd_data in ipairs(self.commands) do
				if cmd_data.name:lower():sub(1, #cmd_part) == cmd_part then
					current_match = cmd_data.name
					local suffix = cmd_data.name:sub(#cmd_part + 1)
					current_suggestion_full = text .. suffix
					
					local measure_text = text:gsub(" ", "\194\160")
					local size = text_service:GetTextSize(measure_text, input_box.TextSize, input_box.Font, vec2(10000, 100))
					
					suggestion_label.Text = suffix
					suggestion_label.Position = dim2(0, 35 + size.X, 0, 0)
					return
				end
			end
		end
	end
	
	input_box:GetPropertyChangedSignal("Text"):Connect(update_suggestion)
	
	input_box.FocusLost:Connect(function(enter_pressed)
		if enter_pressed then
			local text = input_box.Text
			if text ~= "" then
				self:run_command(self.prefix .. text)
				input_box.Text = ""
				toggle_cmd_bar(false)
			end
		end
	end)
	
	uis.InputBegan:Connect(function(input, gpe)
		if input.KeyCode == self.toggle_key and not gpe then
			toggle_cmd_bar()
		elseif is_visible and input.KeyCode == Enum.KeyCode.Tab then
			if current_match and current_suggestion_full ~= "" then
				input_box.Text = current_suggestion_full
				input_box.CursorPosition = #input_box.Text + 1
				update_suggestion()
				task.defer(function() input_box:CaptureFocus() end)
			end
		end
	end)
	
	return input_box, backdrop
end

function library:make_draggable(gui)
	local dragging
	local drag_input
	local drag_start
	local start_pos
	
	gui:SetAttribute("TargetPos", gui.Position)

	gui.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			drag_start = input.Position
			start_pos = gui.Position
			gui:SetAttribute("TargetPos", start_pos)
			
			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end
	end)
	
	gui.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
			drag_input = input
		end
	end)
	
	uis.InputChanged:Connect(function(input)
		if input == drag_input and dragging then
			local delta = input.Position - drag_start
			local target = dim2(start_pos.X.Scale, start_pos.X.Offset + delta.X, start_pos.Y.Scale, start_pos.Y.Offset + delta.Y)
			gui:SetAttribute("TargetPos", target)
		end
	end)
	
	task.spawn(function()
		while gui.Parent do
			local target = gui:GetAttribute("TargetPos")
			if target then
				gui.Position = gui.Position:Lerp(target, 0.08)
			end
			run.RenderStepped:Wait()
		end
	end)
end

function library:create_command_list()
	local command_list_holder = Instance.new("Frame")
	command_list_holder.Name = "CommandListHolder"
	command_list_holder.Size = dim2(0, 400, 0, 320)
	command_list_holder.Position = dim2(0.5, 0, 0.5, 0)
	command_list_holder.AnchorPoint = vec2(0.5, 0.5)
	command_list_holder.BackgroundTransparency = 1
	command_list_holder.Visible = false
	command_list_holder.Parent = self.screen_gui
	
	self:make_draggable(command_list_holder)
	
	local cl_shadow = Instance.new("ImageLabel")
	cl_shadow.Name = "Shadow"
	cl_shadow.AnchorPoint = vec2(0.5, 0.5)
	cl_shadow.Position = UDim2.fromScale(0.5, 0.5)
	cl_shadow.Size = dim2(1, 10, 1, 10)
	cl_shadow.BackgroundTransparency = 1
	cl_shadow.Image = "rbxassetid://1316045217"
	cl_shadow.ImageColor3 = rgb(0, 0, 0)
	cl_shadow.ImageTransparency = 1
	cl_shadow.ScaleType = Enum.ScaleType.Slice
	cl_shadow.SliceCenter = rect(10, 10, 118, 118)
	cl_shadow.ZIndex = 0
	cl_shadow.Parent = command_list_holder
	
	local command_list_frame = Instance.new("CanvasGroup")
	command_list_frame.Name = "CommandListFrame"
	command_list_frame.Size = dim2(1, 0, 1, 0)
	command_list_frame.Position = dim2(0, 0, 0, 0)
	command_list_frame.BackgroundColor3 = rgb(45, 45, 45)
	command_list_frame.BackgroundTransparency = 0.15
	command_list_frame.BorderSizePixel = 0
	command_list_frame.GroupTransparency = 1
	command_list_frame.Parent = command_list_holder
	
	local cl_scale = Instance.new("UIScale")
	cl_scale.Parent = command_list_frame
	
	local cl_corner = Instance.new("UICorner")
	cl_corner.CornerRadius = dim(0, 12)
	cl_corner.Parent = command_list_frame
	
	local cl_stroke = Instance.new("UIStroke")
	cl_stroke.Color = rgb(80, 80, 80)
	cl_stroke.Thickness = 1
	cl_stroke.Parent = command_list_frame
	
	local cl_title = Instance.new("TextLabel")
	cl_title.Size = dim2(1, -40, 0, 30)
	cl_title.Position = dim2(0, 10, 0, 5)
	cl_title.BackgroundTransparency = 1
	cl_title.Text = "Commands"
	cl_title.TextColor3 = rgb(255, 255, 255)
	cl_title.TextTransparency = 0.3
	cl_title.TextSize = 20
	cl_title.Font = Enum.Font.GothamSemibold
	cl_title.TextXAlignment = Enum.TextXAlignment.Left
	cl_title.Parent = command_list_frame
	
	local cl_close = Instance.new("TextButton")
	cl_close.Size = dim2(0, 20, 0, 20)
	cl_close.Position = dim2(1, -25, 0, 8)
	cl_close.BackgroundTransparency = 1
	cl_close.Text = "X"
	cl_close.TextColor3 = rgb(200, 200, 200)
	cl_close.TextSize = 14
	cl_close.Font = Enum.Font.Gotham
	cl_close.Parent = command_list_frame
	
	cl_close.MouseButton1Click:Connect(function()
		self:toggle_command_list(false)
	end)
	
	local scrolling_frame = Instance.new("ScrollingFrame")
	scrolling_frame.Size = dim2(1, -20, 1, -50)
	scrolling_frame.Position = dim2(0, 10, 0, 40)
	scrolling_frame.BackgroundTransparency = 1
	scrolling_frame.BorderSizePixel = 0
	scrolling_frame.ScrollBarThickness = 4
	scrolling_frame.ScrollBarImageColor3 = rgb(80, 80, 80)
	scrolling_frame.AutomaticCanvasSize = Enum.AutomaticSize.Y
	scrolling_frame.CanvasSize = dim2(0, 0, 0, 0)
	scrolling_frame.Parent = command_list_frame
	
	local ui_list_layout = Instance.new("UIListLayout")
	ui_list_layout.SortOrder = Enum.SortOrder.LayoutOrder
	ui_list_layout.Padding = dim(0, 5)
	ui_list_layout.Parent = scrolling_frame
	
	local ui_padding = Instance.new("UIPadding")
	ui_padding.PaddingTop = dim(0, 5)
	ui_padding.PaddingLeft = dim(0, 2)
	ui_padding.Parent = scrolling_frame
	
	local cl_search_frame = Instance.new("Frame")
	cl_search_frame.Name = "SearchFrame"
	cl_search_frame.LayoutOrder = -1
	cl_search_frame.Size = dim2(1, -10, 0, 20)
	cl_search_frame.BackgroundColor3 = rgb(30, 30, 30)
	cl_search_frame.BackgroundTransparency = 0.5
	cl_search_frame.BorderSizePixel = 0
	cl_search_frame.Parent = scrolling_frame
	
	local cl_search_corner = Instance.new("UICorner")
	cl_search_corner.CornerRadius = dim(0, 6)
	cl_search_corner.Parent = cl_search_frame
	
	local cl_search_stroke = Instance.new("UIStroke")
	cl_search_stroke.Color = rgb(60, 60, 60)
	cl_search_stroke.Thickness = 1
	cl_search_stroke.Parent = cl_search_frame
	
	local cl_search_input = Instance.new("TextBox")
	cl_search_input.Name = "Input"
	cl_search_input.Size = dim2(1, -10, 1, 0)
	cl_search_input.Position = dim2(0, 10, 0, 0)
	cl_search_input.BackgroundTransparency = 1
	cl_search_input.Text = ""
	cl_search_input.PlaceholderText = "Search commands..."
	cl_search_input.TextColor3 = rgb(220, 220, 220)
	cl_search_input.PlaceholderColor3 = rgb(120, 120, 120)
	cl_search_input.TextSize = 12
	cl_search_input.Font = Enum.Font.Gotham
	cl_search_input.TextXAlignment = Enum.TextXAlignment.Left
	cl_search_input.Parent = cl_search_frame
	
	self.command_list_holder = command_list_holder
	self.command_list_frame = command_list_frame
	self.cl_shadow = cl_shadow
	self.cl_scale = cl_scale
	self.scrolling_frame = scrolling_frame
	self.cl_search_input = cl_search_input
	
	cl_search_input:GetPropertyChangedSignal("Text"):Connect(function()
		local query = cl_search_input.Text:lower()
		for _, child in ipairs(scrolling_frame:GetChildren()) do
			if child:IsA("Frame") and child.Name ~= "SearchFrame" then
				if child.Name:lower():find(query) then
					child.Visible = true
				else
					child.Visible = false
				end
			end
		end
	end)
	
	self:populate_command_list()
end

function library:populate_command_list()
	if not self.scrolling_frame then return end
	
	for _, child in ipairs(self.scrolling_frame:GetChildren()) do
		if child:IsA("Frame") and child.Name ~= "SearchFrame" then 
			child:Destroy() 
		end
	end
	
	for _, cmd in ipairs(self.commands) do
		local entry = Instance.new("Frame")
		entry.Name = cmd.name
		entry.Size = dim2(1, 0, 0, 40)
		entry.BackgroundTransparency = 1
		entry.Parent = self.scrolling_frame
		
		if not cmd.args_display or cmd.args_display == "" then
			local cmd_text = Instance.new("TextButton")
			cmd_text.Name = "CmdLabel"
			cmd_text.Size = dim2(1, 0, 0, 20)
			cmd_text.Position = dim2(0, 0, 0, 10)
			cmd_text.AnchorPoint = vec2(0, 0.5)
			cmd_text.BackgroundTransparency = 1
			cmd_text.Text = string.format("%s%s", self.prefix, cmd.name)
			cmd_text.TextColor3 = rgb(255, 255, 255)
			cmd_text.TextTransparency = 0.3
			cmd_text.TextSize = 16
			cmd_text.Font = Enum.Font.GothamMedium
			cmd_text.TextXAlignment = Enum.TextXAlignment.Left
			cmd_text.AutoButtonColor = false
			cmd_text.Parent = entry

			local cmd_scale = Instance.new("UIScale")
			cmd_scale.Parent = cmd_text
			
			cmd_text.MouseEnter:Connect(function()
				tween_service:Create(cmd_text, TweenInfo.new(0.2), { TextTransparency = 0.1 }):Play()
			end)
			cmd_text.MouseLeave:Connect(function()
				tween_service:Create(cmd_text, TweenInfo.new(0.2), { TextTransparency = 0.3 }):Play()
			end)

			cmd_text.MouseButton1Click:Connect(function()
				tween_service:Create(cmd_scale, TweenInfo.new(0.05, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), { Scale = 0.9 }):Play()
				tween_service:Create(cmd_text, TweenInfo.new(0.05, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), { TextTransparency = 0 }):Play()
				
				task.delay(0.1, function()
					tween_service:Create(cmd_scale, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), { Scale = 1 }):Play()
					tween_service:Create(cmd_text, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), { TextTransparency = 0.1 }):Play()
				end)
				
				self:run_command(self.prefix .. cmd.name)
			end)
		else
			local cmd_container = Instance.new("Frame")
			cmd_container.Name = "CmdContainer"
			cmd_container.Size = dim2(1, 0, 0, 20)
			cmd_container.Position = dim2(0, 0, 0, 10)
			cmd_container.AnchorPoint = vec2(0, 0.5)
			cmd_container.BackgroundTransparency = 1
			cmd_container.Parent = entry
			
			local ui_layout = Instance.new("UIListLayout")
			ui_layout.FillDirection = Enum.FillDirection.Horizontal
			ui_layout.SortOrder = Enum.SortOrder.LayoutOrder
			ui_layout.Padding = dim(0, 4)
			ui_layout.Parent = cmd_container

			local name_label = Instance.new("TextButton")
			name_label.Name = "CmdLabel"
			name_label.BackgroundTransparency = 1
			name_label.Text = string.format("%s%s", self.prefix, cmd.name)
			name_label.TextColor3 = rgb(255, 255, 255)
			name_label.TextTransparency = 0.3
			name_label.TextSize = 16
			name_label.Font = Enum.Font.GothamMedium
			name_label.AutomaticSize = Enum.AutomaticSize.X
			name_label.Size = dim2(0, 0, 1, 0)
			name_label.TextXAlignment = Enum.TextXAlignment.Left
			name_label.Parent = cmd_container
			
			local args_container = Instance.new("Frame")
			args_container.Name = "ArgsContainer"
			args_container.BackgroundTransparency = 1
			args_container.AutomaticSize = Enum.AutomaticSize.X
			args_container.Size = dim2(0, 0, 1, 0)
			args_container.Parent = cmd_container

			local args_layout = Instance.new("UIListLayout")
			args_layout.FillDirection = Enum.FillDirection.Horizontal
			args_layout.SortOrder = Enum.SortOrder.LayoutOrder
			args_layout.Padding = dim(0, 0)
			args_layout.Parent = args_container

			local open_bracket = Instance.new("TextLabel")
			open_bracket.Text = "["
			open_bracket.BackgroundTransparency = 1
			open_bracket.TextColor3 = rgb(255, 255, 255)
			open_bracket.TextTransparency = 0.3
			open_bracket.TextSize = 16
			open_bracket.Font = Enum.Font.GothamMedium
			open_bracket.AutomaticSize = Enum.AutomaticSize.X
			open_bracket.Size = dim2(0, 0, 1, 0)
			open_bracket.Parent = args_container

			local arg_box = Instance.new("TextBox")
			arg_box.Name = "ArgBox"
			arg_box.BackgroundTransparency = 1
			arg_box.TextColor3 = rgb(255, 255, 255)
			arg_box.TextTransparency = 0.3
			arg_box.PlaceholderColor3 = rgb(255, 255, 255)
			arg_box.TextSize = 16
			arg_box.Font = Enum.Font.GothamMedium
			arg_box.TextXAlignment = Enum.TextXAlignment.Center
			arg_box.AutomaticSize = Enum.AutomaticSize.X
			arg_box.Size = dim2(0, 4, 1, 0)
			arg_box.ClearTextOnFocus = true
			arg_box.ClipsDescendants = false
			arg_box.Parent = args_container
            
			arg_box:GetPropertyChangedSignal("Text"):Connect(function()
				if arg_box.Text == "" then
					arg_box.Size = dim2(0, 4, 1, 0)
				else
					arg_box.Size = dim2(0, 0, 1, 0)
				end
			end)
			
			local close_bracket = Instance.new("TextLabel")
			close_bracket.Text = "]"
			close_bracket.BackgroundTransparency = 1
			close_bracket.TextColor3 = rgb(255, 255, 255)
			close_bracket.TextTransparency = 0.3
			close_bracket.TextSize = 16
			close_bracket.Font = Enum.Font.GothamMedium
			close_bracket.AutomaticSize = Enum.AutomaticSize.X
			close_bracket.Size = dim2(0, 0, 1, 0)
			close_bracket.Parent = args_container
			
			name_label.MouseButton1Click:Connect(function()
				arg_box:CaptureFocus()
			end)

			local placeholder = cmd.args_display
			placeholder = placeholder:gsub("^%[", ""):gsub("%]$", ""):gsub("^<", ""):gsub(">$", "")
			
			arg_box.Text = ""
			arg_box.PlaceholderText = placeholder
			
			arg_box.Focused:Connect(function()
				arg_box.PlaceholderText = ""
			end)
			
			arg_box.FocusLost:Connect(function(enter)
				arg_box.PlaceholderText = placeholder
				if enter then
					local val = arg_box.Text
					if val ~= "" then
						val = val:gsub("^%[", ""):gsub("%]$", "")
						self:run_command(self.prefix .. cmd.name .. " " .. val)
						arg_box.Text = ""
					end
				else
					arg_box.Text = ""
				end
			end)
		end
		
		local desc_label = Instance.new("TextLabel")
		desc_label.Name = "CmdDesc"
		desc_label.Size = dim2(1, 0, 0, 15)
		desc_label.Position = dim2(0, 0, 0, 22)
		desc_label.BackgroundTransparency = 1
		
		local alias_str = ""
		if cmd.aliases and #cmd.aliases > 0 then
			alias_str = " (Aliases: " .. table.concat(cmd.aliases, ", ") .. ")"
		end
		
		desc_label.Text = cmd.desc .. alias_str
		desc_label.TextColor3 = rgb(180, 180, 180)
		desc_label.TextTransparency = 0.4
		desc_label.TextSize = 12
		desc_label.Font = Enum.Font.Gotham
		desc_label.TextXAlignment = Enum.TextXAlignment.Left
		desc_label.Parent = entry
	end
end

function library:toggle_command_list(show)
	if show == nil then show = not self.command_list_holder.Visible end
	
	if show then
		self.command_list_holder.Visible = true
		if self.command_list_frame.GroupTransparency >= 0.9 then
			self.command_list_frame.GroupTransparency = 1
			self.cl_shadow.ImageTransparency = 1
			self.cl_scale.Scale = 0.9
		end
		
		tween_service:Create(self.command_list_frame, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
			GroupTransparency = 0
		}):Play()
		tween_service:Create(self.cl_shadow, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
			ImageTransparency = 0.8
		}):Play()
		tween_service:Create(self.cl_scale, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
			Scale = 1
		}):Play()
	else
		tween_service:Create(self.command_list_frame, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
			GroupTransparency = 1
		}):Play()
		tween_service:Create(self.cl_shadow, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
			ImageTransparency = 1
		}):Play()
		tween_service:Create(self.cl_scale, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
			Scale = 0.9
		}):Play()
		
		task.delay(0.2, function()
			if self.command_list_frame.GroupTransparency >= 0.9 then
				self.command_list_holder.Visible = false
			end
		end)
	end
end

return library
